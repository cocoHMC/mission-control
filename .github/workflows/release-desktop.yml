name: Release Desktop

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-desktop
  cancel-in-progress: false

env:
  # Electron's postinstall download is flaky in CI (transient 5xx). electron-builder will
  # download the correct Electron zips during packaging.
  ELECTRON_SKIP_BINARY_DOWNLOAD: "1"

jobs:
  mac:
    name: macOS
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Pin pnpm
        run: corepack prepare pnpm@10.28.2 --activate

      - name: Set Desktop Version From Tag
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"
          APP_VERSION="$VERSION" node -e "const fs=require('fs'); const p='apps/desktop/package.json'; const pkg=JSON.parse(fs.readFileSync(p,'utf8')); pkg.version=process.env.APP_VERSION; if(!pkg.version) throw new Error('APP_VERSION missing'); fs.writeFileSync(p, JSON.stringify(pkg,null,2)+'\\n'); console.log('desktop version ->', pkg.version);"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download PocketBase Binaries (macOS x64 + arm64)
        run: |
          PB_ARCH=amd64 PB_BIN_PATH=pb/pocketbase-darwin-amd64 bash scripts/pb_install.sh
          PB_ARCH=arm64 PB_BIN_PATH=pb/pocketbase-darwin-arm64 bash scripts/pb_install.sh

      - name: Build Web + Worker + Desktop
        run: pnpm -r build

      - name: Build Desktop (DMG + ZIP)
        run: pnpm -C apps/desktop exec electron-builder --mac dmg zip --arm64 --x64 --publish never

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos
          if-no-files-found: error
          path: |
            apps/desktop/release/*.dmg
            apps/desktop/release/*.zip
            apps/desktop/release/*.yml
            apps/desktop/release/*.blockmap

  linux:
    name: Linux (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Pin pnpm
        run: corepack prepare pnpm@10.28.2 --activate

      - name: Set Desktop Version From Tag
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"
          APP_VERSION="$VERSION" node -e "const fs=require('fs'); const p='apps/desktop/package.json'; const pkg=JSON.parse(fs.readFileSync(p,'utf8')); pkg.version=process.env.APP_VERSION; if(!pkg.version) throw new Error('APP_VERSION missing'); fs.writeFileSync(p, JSON.stringify(pkg,null,2)+'\\n'); console.log('desktop version ->', pkg.version);"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download PocketBase Binary (linux x64)
        run: PB_OS=linux PB_ARCH=amd64 PB_BIN_PATH=pb/pocketbase-linux-amd64 bash scripts/pb_install.sh

      - name: Build Web + Worker + Desktop
        run: pnpm -r build

      - name: Build Desktop (AppImage + DEB)
        run: pnpm -C apps/desktop exec electron-builder --linux AppImage deb --x64 --publish never

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux
          if-no-files-found: error
          path: |
            apps/desktop/release/*.AppImage
            apps/desktop/release/*.deb
            apps/desktop/release/*.yml
            apps/desktop/release/*.blockmap

  windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Workaround: isolate user directories (avoid Next glob EPERM on runner profile)"
        shell: pwsh
        run: |
          $base = Join-Path $env:GITHUB_WORKSPACE '.ci-user'
          $homeDir = $base
          $local = Join-Path $base 'AppData\\Local'
          $roaming = Join-Path $base 'AppData\\Roaming'
          $temp = Join-Path $local 'Temp'
          New-Item -ItemType Directory -Force -Path $homeDir, $local, $roaming, $temp | Out-Null
          "USERPROFILE=$homeDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "HOME=$homeDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "LOCALAPPDATA=$local" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "APPDATA=$roaming" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TEMP=$temp" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "TMP=$temp" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Pin pnpm
        run: corepack prepare pnpm@10.28.2 --activate

      - name: "Workaround: remove legacy junctions that break Next glob"
        shell: pwsh
        run: |
          # Next.js build on GitHub-hosted Windows runners can hit glob EPERM errors when it
          # walks legacy profile junctions / reparse points. Delete them (removes junctions,
          # not their targets) before building.
          $profile = $env:USERPROFILE
          if ($null -ne $profile -and $profile -ne '' -and (Test-Path $profile)) {
            $reparseDirs = @(
              Get-ChildItem -LiteralPath $profile -Force -Recurse -Directory -Attributes ReparsePoint -ErrorAction SilentlyContinue
            )
            Write-Host "Found $($reparseDirs.Count) reparse-point directories under $profile"
            foreach ($d in $reparseDirs) {
              cmd /c rmdir "$($d.FullName)" 2>$null
            }
          }

      - name: Set Desktop Version From Tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          echo "APP_VERSION=$VERSION" >> "$GITHUB_ENV"
          APP_VERSION="$VERSION" node -e "const fs=require('fs'); const p='apps/desktop/package.json'; const pkg=JSON.parse(fs.readFileSync(p,'utf8')); pkg.version=process.env.APP_VERSION; if(!pkg.version) throw new Error('APP_VERSION missing'); fs.writeFileSync(p, JSON.stringify(pkg,null,2)+'\\n'); console.log('desktop version ->', pkg.version);"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Download PocketBase Binary (windows x64)
        shell: bash
        run: PB_OS=windows PB_ARCH=amd64 PB_BIN_PATH=pb/pocketbase-windows-amd64.exe bash scripts/pb_install.sh

      - name: Build Web + Worker + Desktop
        run: pnpm -r build

      - name: Build Desktop (NSIS)
        env:
          # electron-builder uses this to generate update metadata, even when not publishing.
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm -C apps/desktop exec electron-builder --win nsis --x64 --publish never

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows
          if-no-files-found: error
          path: |
            apps/desktop/release/*.exe
            apps/desktop/release/*.blockmap
            apps/desktop/release/*.yml

  publish:
    name: Publish Release (All Platforms)
    runs-on: ubuntu-latest
    needs:
      - mac
      - linux
      - windows
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: desktop-macos
          path: release-assets

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: desktop-linux
          path: release-assets

      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: desktop-windows
          path: release-assets

      - name: Ensure Release Exists + Upload Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          # Create the GitHub Release if it doesn't exist yet.
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "$TAG" --notes ""
          fi

          shopt -s globstar nullglob
          files=(release-assets/**/*)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No release assets found under release-assets/"
            exit 1
          fi

          gh release upload "$TAG" "${files[@]}" --clobber

      - name: Write Release Notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          REPO="${GITHUB_REPOSITORY}"
          DOWNLOAD_BASE="https://github.com/${REPO}/releases/download/${TAG}"

          # Deterministic names (keeps the release body stable and human-friendly).
          mac_arm_dmg="Mission-Control-v${VERSION}-macos-arm64.dmg"
          mac_x64_dmg="Mission-Control-v${VERSION}-macos-x64.dmg"
          win_setup="Mission-Control-v${VERSION}-windows-x64-setup.exe"
          linux_appimage="Mission-Control-v${VERSION}-linux-x86_64.AppImage"
          linux_deb="Mission-Control-v${VERSION}-linux-amd64.deb"

          {
            echo "> [!IMPORTANT]"
            echo "> Download **one** installer from the table below. Ignore everything else under **Assets**."
            echo ">"
            echo "> - macOS: Apple menu → **About This Mac** → look for **Chip** (Apple Silicon) vs **Processor** (Intel)"
            echo "> - Linux: use **AppImage** for most distros; use **.deb** if you're on Debian/Ubuntu"
            echo ""
            echo "# Downloads (Pick One)"
            echo ""
            echo "| Your device | Download | What it is |"
            echo "|---|---|---|"
            echo "| macOS Apple Silicon (M1/M2/M3) | [$mac_arm_dmg](${DOWNLOAD_BASE}/${mac_arm_dmg}) | Installer (DMG) |"
            echo "| macOS Intel | [$mac_x64_dmg](${DOWNLOAD_BASE}/${mac_x64_dmg}) | Installer (DMG) |"
            echo "| Windows 10/11 (x64) | [$win_setup](${DOWNLOAD_BASE}/${win_setup}) | Installer (EXE) |"
            echo "| Linux (x86_64) | [$linux_appimage](${DOWNLOAD_BASE}/${linux_appimage}) | Portable app (AppImage) |"
            echo "| Debian/Ubuntu (x86_64) | [$linux_deb](${DOWNLOAD_BASE}/${linux_deb}) | Package (DEB) |"
            echo ""
            echo "> [!NOTE]"
            echo "> Files like \`latest*.yml\`, \`*.blockmap\`, and \`*.zip\` are used for in-app auto-updates and can be ignored for manual installs."
            echo ""
            echo "## Changes"
            echo ""

            PREV="$(git tag --list 'v*' --sort=-v:refname | grep -v "^${TAG}$" | head -n 1 || true)"
            if [ -n "$PREV" ]; then
              git log --pretty=format:'- %s (%h)' "${PREV}..${TAG}"
            else
              git log --pretty=format:'- %s (%h)' "${TAG}"
            fi
            echo ""
          } > RELEASE_NOTES.md

          gh release edit "$TAG" --title "$TAG" --notes-file RELEASE_NOTES.md
